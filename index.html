<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=1.0, viewport-fit=cover">
    <!-- PWA 支持 -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <!-- SEO优化 -->
    <meta name="description" content="基于MQTT的校园环境实时监测系统，支持温度、湿度、风速、光照等多参数监控">
    <meta name="keywords" content="环境监测,MQTT,物联网,温度监控,智慧校园">
    <!-- 严格 CSP 防止 XSS 与供应链攻击 -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline';
        connect-src 'self' wss: ws: https://ark.cn-beijing.volces.com;
        img-src 'self' data:;
        font-src 'self';
        base-uri 'self';
        form-action 'self';
        upgrade-insecure-requests
    ">
    <title>校园环境信息</title>
    <!-- 预加载关键资源 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="stylesheet" href="css/style.css">

    <!-- ECharts 库首先加载 -->
    <script src="js/echarts.min.js" defer></script>
    <!-- MQTT 库（本地文件，应用层ClientID过滤实现多网页隔离）-->
    <script src="js/mqttws31.min.js" defer></script>
</head>
<body>
    <div class="container">
        <!-- 加载指示器 -->
        <div id="loadingIndicator" class="loading-indicator" aria-live="polite" aria-label="正在加载">
            <div class="spinner" role="status">
                <span class="sr-only">加载中...</span>
            </div>
        </div>

        <!-- 原有内容：标题/菜单/数据卡片/图表 -->
        <header class="title-container" id="titleContainer">
            <nav class="menu-container">
                <div class="hamburger-menu" id="hamburgerMenu">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </div>
                <ul class="dropdown-menu" id="dropdownMenu">
                    <li class="dropdown-item" data-action="user-center">用户中心</li>
                    <li class="dropdown-divider"></li>
                    <li class="dropdown-item admin-only is-hidden" id="menuDeviceControl" data-action="device-control">环境设备控制</li>
                    <li class="dropdown-item" data-action="chart-setting">图表显示设置</li>
                    <li class="dropdown-item" data-action="data-time">设置历史时间</li>
                    <li class="dropdown-item" data-action="data-export">导出监控数据</li>
                    <li class="dropdown-divider"></li>
                    <li class="dropdown-item" data-action="device-version">设备版本</li>
                    <li class="dropdown-item" data-action="about">关于系统</li>
                </ul>
            </nav>
            <div class="title-wrapper">
                <h1 class="main-title">环境数据</h1>
            </div>
            <div class="user-status-container">
                <div class="combined-status" id="combined-status">
                    <span class="status-dot"></span>
                    <span class="status-text" id="status-text">未登录</span>
                    <span class="user-name is-hidden" id="user-name"></span>
                </div>
            </div>
        </header>

        <main class="data-grid" role="main">
            <article class="data-card temp-card temp-normal" id="temperatureCard" aria-label="温度监测">
                <div class="temp-header">
                    <h3>温度</h3>
                    <span class="temp-icon" id="tempIcon">🌡️</span>
                </div>
                
                <div class="temp-main-display">
                    <div class="temp-value-wrapper">
                        <div class="temp-value" id="temperature">--</div>
                        <span class="temp-unit">℃</span>
                    </div>
                    <div class="temp-status">
                        <span class="temp-level" id="tempLevel">--</span>
                        <span class="temp-trend" id="tempTrend">→</span>
                    </div>
                </div>

                <div class="temp-progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="tempProgress" style="width: 0%;"></div>
                        <div class="progress-marker cold" title="-10℃"></div>
                        <div class="progress-marker normal" title="13℃"></div>
                        <div class="progress-marker hot" title="36℃"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-label left">-10</span>
                        <span class="progress-label center">13</span>
                        <span class="progress-label right">36</span>
                    </div>
                </div>

            </article>
            <article class="data-card humidity-card" id="humidityCard" aria-label="湿度监测">
                <div class="card-header">
                    <h3>湿度</h3>
                    <span class="card-icon" id="humidityIcon">💧</span>
                </div>
                
                <div class="card-main-display">
                    <div class="card-value-wrapper">
                        <div class="card-value" id="humidity">--</div>
                        <span class="card-unit">%</span>
                    </div>
                    <div class="card-status">
                        <span class="card-level" id="humidityLevel">--</span>
                        <span class="card-trend" id="humidityTrend">→</span>
                    </div>
                </div>

                <div class="card-progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="humidityProgress" style="width: 0%;"></div>
                        <div class="progress-marker left" title="0%"></div>
                        <div class="progress-marker middle" title="50%"></div>
                        <div class="progress-marker right" title="100%"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-label left">0</span>
                        <span class="progress-label center">50</span>
                        <span class="progress-label right">100</span>
                    </div>
                </div>

            </article>
            <article class="data-card wind-card" id="windSpeedCard" aria-label="风速监测">
                <div class="card-header">
                    <h3>风速</h3>
                    <span class="card-icon" id="windSpeedIcon">💨</span>
                </div>
                
                <div class="card-main-display">
                    <div class="card-value-wrapper">
                        <div class="card-value" id="windSpeed">--</div>
                        <span class="card-unit">m/s</span>
                    </div>
                    <div class="card-status">
                        <span class="card-level" id="windSpeedLevel">--</span>
                        <span class="card-trend" id="windSpeedTrend">→</span>
                    </div>
                </div>

                <div class="card-progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="windSpeedProgress" style="width: 0%;"></div>
                        <div class="progress-marker left" title="0m/s"></div>
                        <div class="progress-marker middle" title="10m/s"></div>
                        <div class="progress-marker right" title="20m/s"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-label left">0</span>
                        <span class="progress-label center">10</span>
                        <span class="progress-label right">20</span>
                    </div>
                </div>

            </article>

            <article class="data-card illumination-card" id="illuminationCard" aria-label="光照强度监测">
                <div class="card-header">
                    <h3>光照强度</h3>
                    <span class="card-icon" id="illuminationIcon">☀️</span>
                </div>
                
                <div class="card-main-display">
                    <div class="card-value-wrapper">
                        <div class="card-value" id="illumination">--</div>
                        <span class="card-unit">lux</span>
                    </div>
                    <div class="card-status">
                        <span class="card-level" id="illuminationLevel">--</span>
                        <span class="card-trend" id="illuminationTrend">→</span>
                    </div>
                </div>

                <div class="card-progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="illuminationProgress" style="width: 0%;"></div>
                        <div class="progress-marker left" title="0lux"></div>
                        <div class="progress-marker middle" title="500lux"></div>
                        <div class="progress-marker right" title="1000lux"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-label left">0</span>
                        <span class="progress-label center">500</span>
                        <span class="progress-label right">1000</span>
                    </div>
                </div>

            </article>
        
            <!-- PM2.5 数值卡片 -->
            <article class="data-card PM2-card" id="PM2card" aria-label="PM2.5监测">
                <div class="card-header">
                    <h3>PM2.5</h3>
                    <span class="card-icon" id="PM2Icon">🌳</span>
                </div>

                <div class="card-main-display">
                    <div class="card-value-wrapper">
                        <div class="card-value" id="PM2">--</div>
                        <span class="card-unit PM2unit">μg/m³</span>
                    </div>
                    <div class="card-status">
                        <span class="card-level" id="PM2Level">--</span>
                        <span class="card-trend" id="PM2Trend">→</span>
                    </div>
                </div>

                <div class="card-progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="PM2Progress" style="width: 0%;"></div>
                        <div class="progress-marker left" title="0ug/m³"></div>
                        <div class="progress-marker middle" title="75ug/m³"></div>
                        <div class="progress-marker right" title="150ug/m³"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-label left">0</span>
                        <span class="progress-label center">75</span>
                        <span class="progress-label right">150</span>
                    </div>
                </div>

            </article>

            <!-- 紫外线强度卡片 -->
            <article class="data-card sunray-card" id="sunrayCard" aria-label="紫外线强度监测">
                <div class="card-header">
                    <h3>紫外线强度</h3>
                    <span class="card-icon" id="sunrayIcon">⛱️</span>
                </div>

                <div class="card-main-display">
                    <div class="card-value-wrapper">
                        <div class="card-value" id="sunray">--</div>
                        <span class="card-unit">UVI</span>
                    </div>
                    <div class="card-status">
                        <span class="card-level" id="sunrayLevel">--</span>
                        <span class="card-trend" id="sunrayTrend">→</span>
                    </div>
                </div>

                <div class="card-progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="sunrayProgress" style="width: 0%;"></div>
                        <div class="progress-marker left" title="0UVI"></div>
                        <div class="progress-marker middle" title="5UVI"></div>
                        <div class="progress-marker right" title="10UVI"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-label left">0</span>
                        <span class="progress-label center">5</span>
                        <span class="progress-label right">10</span>
                    </div>
                </div>

            </article>

            <article class="data-card pressure-card" id="pressureCard" aria-label="大气压强监测">
                <div class="card-header">
                    <h3>大气压强</h3>
                    <span class="card-icon" id="pressureIcon">⏲️</span>
                </div>
                
                <div class="card-main-display">
                    <div class="card-value-wrapper">
                        <div class="card-value" id="pressure">--</div>
                        <span class="card-unit">KPa</span>
                    </div>
                    <div class="card-status">
                        <span class="card-level" id="pressureLevel">--</span>
                        <span class="card-trend" id="pressureTrend">→</span>
                    </div>
                </div>

                <div class="card-progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="pressureProgress" style="width: 0%;"></div>
                        <div class="progress-marker left" title="90KPa"></div>
                        <div class="progress-marker middle" title="101.325KPa"></div>
                        <div class="progress-marker right" title="110KPa"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-label left">90</span>
                        <span class="progress-label center">101</span>
                        <span class="progress-label right">110</span>
                    </div>
                </div>
            </article>

            <article class="data-card altitude-card" id="altitudeCard" aria-label="海拔高度监测">
                <div class="card-header">
                    <h3>海拔高度</h3>
                    <span class="card-icon" id="altitudeIcon">🏔️</span>
                </div>
                
                <div class="card-main-display">
                    <div class="card-value-wrapper">
                        <div class="card-value" id="altitude">--</div>
                        <span class="card-unit">m</span>
                    </div>
                    <div class="card-status">
                        <span class="card-level" id="altitudeLevel">--</span>
                        <span class="card-trend" id="altitudeTrend">→</span>
                    </div>
                </div>

                <div class="card-progress-bar">
                    <div class="progress-track">
                        <div class="progress-fill" id="altitudeProgress" style="width: 0%;"></div>
                        <div class="progress-marker left" title="0m"></div>
                        <div class="progress-marker middle" title="1500m"></div>
                        <div class="progress-marker right" title="3000m"></div>
                    </div>
                    <div class="progress-labels">
                        <span class="progress-label left">0</span>
                        <span class="progress-label center">1500</span>
                        <span class="progress-label right">3000</span>
                    </div>
                </div>
            </article>
        </main>
        
        <!-- 图表区域 -->
        <section class="chart-legend-section" aria-label="数据选择">
            <div class="chart-legend-wrapper">
                <div class="chart-legend-container">
                    <button class="legend-item" data-series="temperature">
                        <span class="legend-marker" style="background-color: #ef4444;"></span>
                        <span class="legend-content">
                            <span class="legend-text">温度</span>
                            <span class="legend-range">-10 ~ 36°C</span>
                        </span>
                    </button>
                    <button class="legend-item" data-series="humidity">
                        <span class="legend-marker" style="background-color: #0891b2;"></span>
                        <span class="legend-content">
                            <span class="legend-text">湿度</span>
                            <span class="legend-range">0 ~ 100%</span>
                        </span>
                    </button>
                    <button class="legend-item" data-series="windSpeed">
                        <span class="legend-marker" style="background-color: #8b5cf6;"></span>
                        <span class="legend-content">
                            <span class="legend-text">风速</span>
                            <span class="legend-range">0 ~ 20 m/s</span>
                        </span>
                    </button>
                    <button class="legend-item" data-series="illumination">
                        <span class="legend-marker" style="background-color: #f59e0b;"></span>
                        <span class="legend-content">
                            <span class="legend-text">光照</span>
                            <span class="legend-range">0 ~ 1000 lux</span>
                        </span>
                    </button>
                    <button class="legend-item" data-series="PM2">
                        <span class="legend-marker" style="background-color: #10b981;"></span>
                        <span class="legend-content">
                            <span class="legend-text">PM2.5</span>
                            <span class="legend-range">0 ~ 150 μg/m³</span>
                        </span>
                    </button>
                    <button class="legend-item" data-series="sunray">
                        <span class="legend-marker" style="background-color: #3b82f6;"></span>
                        <span class="legend-content">
                            <span class="legend-text">紫外线</span>
                            <span class="legend-range">0 ~ 10 UVI</span>
                        </span>
                    </button>
                </div>
                <button class="chart-refresh-btn" id="chartRefreshBtn" title="刷新图表数据">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
                    </svg>
                </button>
            </div>
        </section>

        <section class="charts-container" aria-label="数据图表区域">
            <figure class="chart-container combined-chart" id="combined-chart" role="img" aria-label="综合数据趋势图表">
                <div class="chart-loading-indicator" id="chartLoadingIndicator">
                    <div class="chart-spinner"></div>
                    <div class="chart-loading-text">正在加载图表库...</div>
                </div>
            </figure>
        </section>
    </div>

    <!-- 新增：用户登录弹窗 -->
    <dialog class="mqtt-config-modal" id="mqttConfigModal">
        <div class="modal-mask"></div>
        <div class="modal-content login-card" role="dialog" aria-modal="true">
            <button type="button" class="modal-close" id="modalClose" aria-label="关闭">×</button>
            
            <div class="login-header">
                <div class="login-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <path d="M5 20C5 16.134 8.134 13 12 13C15.866 13 19 16.134 19 20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </div>
                <h2 class="login-title">用户登录</h2>
                <p class="login-subtitle">登录以访问环境监测系统</p>
            </div>
            
            <div class="login-body">
                <form id="mqttConfigForm" class="login-form" autocomplete="off">
                    <div class="form-group">
                        <label for="mqttUsername" class="form-label">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <path d="M20 21V19C20 16.7909 18.2091 15 16 15H8C5.79086 15 4 16.7909 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            用户名
                        </label>
                        <input type="text" id="mqttUsername" class="form-input" placeholder="请输入用户名" required autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label for="mqttPassword" class="form-label">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                                <rect x="5" y="11" width="14" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M7 11V7C7 4.23858 9.23858 2 12 2C14.7614 2 17 4.23858 17 7V11" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                            密码
                        </label>
                        <div class="password-input-wrapper">
                            <input type="password" id="mqttPassword" class="form-input" placeholder="请输入密码" required autocomplete="off">
                            <button type="button" class="password-toggle" id="passwordToggle" aria-label="显示/隐藏密码">
                                <svg class="eye-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <path d="M2 12C2 12 5 5 12 5C19 5 22 12 22 12C22 12 19 19 12 19C5 19 2 12 2 12Z" stroke="currentColor" stroke-width="2"/>
                                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                <svg class="eye-off-icon is-hidden" width="20" height="20" viewBox="0 0 24 24" fill="none">
                                    <path d="M2 12C2 12 5 5 12 5C19 5 22 12 22 12C22 12 19 19 12 19C5 19 2 12 2 12Z" stroke="currentColor" stroke-width="2"/>
                                    <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                                    <line x1="3" y1="3" x2="21" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" class="btn-login" id="applyConfigBtn">
                        <span class="btn-text">登录系统</span>
                        <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </dialog>

    <!-- 用户中心弹窗 -->
    <dialog class="user-center-modal" id="userCenterModal">
        <div class="modal-mask"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="userCenterTitle">
            <div class="modal-header">
                <h3 class="modal-title" id="userCenterTitle">用户中心</h3>
                <button type="button" class="modal-close" id="userCenterClose" aria-label="关闭对话框">×</button>
            </div>
            <div class="modal-body">
                <div class="user-info-section is-hidden" id="userInfoSection">
                    <div class="settings-row user-info-row">
                        <label class="settings-label">用户名</label>
                        <div class="settings-value" id="userCenterUsername">--</div>
                    </div>
                    <div class="settings-row user-info-row">
                        <label class="settings-label">用户角色</label>
                        <div class="settings-value" id="userCenterRole">--</div>
                    </div>
                    <div class="settings-row user-info-row">
                        <label class="settings-label">连接状态</label>
                        <div class="settings-value" id="userCenterStatus">
                            <span class="status-indicator"></span>
                            <span class="status-text">已连接</span>
                        </div>
                    </div>
                </div>
                <div class="user-login-prompt" id="userLoginPrompt">
                    <div class="login-prompt-icon">🔐</div>
                    <p class="login-prompt-text">您还未登录，请先登录系统</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-logout is-hidden" id="logoutBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    退出登录
                </button>
                <button type="button" class="btn btn-login-prompt is-hidden" id="loginPromptBtn">立即登录</button>
            </div>
        </div>
    </dialog>

    <!-- 设备版本弹窗 -->
    <dialog class="device-version-modal" id="deviceVersionModal">
        <div class="modal-mask"></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <button type="button" class="modal-close" id="deviceVersionModalClose" aria-label="关闭">×</button>
            <div class="modal-body">
                <div class="device-version-content">
                    <div class="version-header">
                        <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4" y="6" width="16" height="12" rx="1.5" stroke="currentColor" stroke-width="1.5" fill="url(#headerGradient)"/>
                            <path d="M8 9h8M8 12h6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/>
                            <circle cx="16" cy="12" r="1" fill="currentColor"/>
                            <defs>
                                <linearGradient id="headerGradient" x1="4" y1="6" x2="20" y2="18" gradientUnits="userSpaceOnUse">
                                    <stop offset="0%" stop-color="#2563eb" stop-opacity="0.15"/>
                                    <stop offset="100%" stop-color="#7c3aed" stop-opacity="0.15"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <h4>设备固件版本</h4>
                    </div>
                    
                    <div class="version-divider"></div>
                    
                    <div class="version-list">
                        <div class="version-item stm32-item">
                            <div class="item-left">
                                <svg class="item-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="6" y="8" width="12" height="8" rx="1" stroke="currentColor" stroke-width="1.5" fill="currentColor" fill-opacity="0.1"/>
                                    <path d="M9 11h6M9 13h4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                                </svg>
                                <div class="item-info">
                                    <div class="item-name">STM32 主控芯片</div>
                                </div>
                            </div>
                            <div class="item-version" id="stm32Version">--</div>
                        </div>

                        <div class="version-item esp32-item">
                            <div class="item-left">
                                <svg class="item-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="6" y="8" width="12" height="8" rx="1" stroke="currentColor" stroke-width="1.5" fill="currentColor" fill-opacity="0.1"/>
                                    <path d="M9 11h6M9 13h5" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                                    <path d="M15.5 11.5l1 1M16.5 11.5l-1 1" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                                </svg>
                                <div class="item-info">
                                    <div class="item-name">ESP32 通信模块</div>
                                </div>
                            </div>
                            <div class="item-version" id="esp32Version">--</div>
                        </div>
                    </div>
                    
                    <div class="version-footer">
                        <span class="footer-time">更新时间：<span id="lastUpdateTime">--</span></span>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    <!-- 关于系统弹窗 -->
    <dialog class="about-modal" id="aboutModal">
        <div class="modal-mask"></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <button type="button" class="modal-close" id="aboutModalClose" aria-label="关闭">×</button>
            <div class="modal-body">
                <div class="about-content">
                    <div class="system-info">
                        <h4>环境数据监测系统</h4>
                        <p class="version">版本：<span id="appVersion">加载中...</span></p>
                    </div>
                    
                    <div class="about-section">
                        <h5>系统介绍</h5>
                        <p>一个基于 MQTT over WebSocket 的前端监控页面，用于实时展示温度、湿度、风速和光照等环境数据。通过与物联网传感器网络对接，实时监测校园环境中的关键指标。</p>
                    </div>

                    <div class="about-section">
                        <h5>主要功能</h5>
                        <ul class="features-list">
                            <li>📊 <strong>多维度数据展示</strong> - 温度、湿度、风速、光照、PM2.5、紫外线</li>
                            <li>📈 <strong>实时数据图表</strong> - 支持多选数据叠加展示，可交互式缩放和拖拽</li>
                            <li>🎨 <strong>数据可视化</strong> - 卡片式展示+趋势图表，支持最大值/最小值对比</li>
                            <li>⚙️ <strong>灵活的设置系统</strong> - 图表平滑、缩放控制、历史时间范围调整</li>
                            <li>💾 <strong>数据导出功能</strong> - 支持监控数据导出为多种格式</li>
                            <li>🤖 <strong>AI智能分析</strong> - 基于当前环境数据的自动分析和建议</li>
                        </ul>
                    </div>
                    
                    <div class="about-section">
                        <h5>核心特性</h5>
                        <ul class="features-list">
                            <li>✅ <strong>MQTT 实时连接</strong> - 支持 WebSocket Secure (wss://) 协议</li>
                            <li>✅ <strong>动态数据图表</strong> - 使用 ECharts 5.4.3 进行实时绘制</li>
                            <li>✅ <strong>响应式设计</strong> - 完美支持桌面、平板、手机设备</li>
                            <li>✅ <strong>现代化 UI</strong> - 渐变设计、流畅动画、专业视觉</li>
                            <li>✅ <strong>AI 智能助手</strong> - 基于大模型的环境数据分析</li>
                            <li>✅ <strong>安全防护</strong> - 严格的内容安全策略（CSP）</li>
                        </ul>
                    </div>

                    <div class="about-section">
                        <h5>技术架构</h5>
                        <p>前端采用 HTML5 + CSS3 + JavaScript 原生开发，无外部UI框架依赖。数据通信基于 WebSocket 实现的 MQTT 协议，确保低延迟的实时数据传输。图表可视化采用 ECharts 库提供强大的数据展示能力。AI 分析功能基于火山方舟豆包大模型。</p>
                    </div>
                    
                    <div class="about-section">
                        <h5>快速开始</h5>
                        <ul class="features-list">
                            <li><strong>用户登录</strong><br>打开右上角菜单 → "用户中心"，填入用户名和密码，完成登录。</li>
                            <li><strong>启用AI助手</strong><br>点击右下角 AI 助手按钮（🤖），在侧边栏中点击设置（⚙️）配置豆包 API，支持通过 MQTT 获取 API Key。配置完成后即可使用 AI 分析功能。</li>
                        </ul>
                    </div>
                    
                    <div class="about-footer">
                        <p style="margin: 0; color: #64748b; font-size: 13px;">© 校园环境监测系统 | 基于开源MQTT.js库</p>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    <!-- 图表显示设置弹窗 -->
    <dialog class="chart-settings-modal" id="chartSettingsModal">
        <div class="modal-mask"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="chartSettingsTitle">
            <div class="modal-header">
                <h3 class="modal-title" id="chartSettingsTitle">显示设置</h3>
                <button type="button" class="modal-close" id="chartSettingsClose" aria-label="关闭对话框">×</button>
            </div>
            <div class="modal-body">
                <form id="chartSettingsForm">
                    <!-- 平滑曲线开关 -->
                    <div class="settings-row">
                        <label class="settings-label">平滑曲线</label>
                        <div class="settings-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="chartSmoothToggle" checked aria-label="启用平滑曲线">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- 重置缩放 -->
                    <div class="settings-row">
                        <label class="settings-label">缩放控制</label>
                        <div class="settings-control">
                            <button type="button" id="chartResetZoomBtn" class="btn" aria-pressed="false">重置缩放</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-save" id="chartSettingsSaveBtn" title="保存并立即应用设置">保存</button>
            </div>
        </div>
    </dialog>

    <!-- 历史数据时间设置弹窗 -->
    <dialog class="chart-settings-modal" id="dataTimeModal">
        <div class="modal-mask"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="dataTimeTitle">
            <div class="modal-header">
                <h3 class="modal-title" id="dataTimeTitle">历史数据时间</h3>
                <button type="button" class="modal-close" id="dataTimeClose" aria-label="关闭对话框">×</button>
            </div>
            <div class="modal-body">
                <form id="dataTimeForm">
                    <div class="settings-row">
                        <label class="settings-label">数据时间范围</label>
                        <div class="settings-control">
                            <select id="dataTimeRange" class="enhanced-select">
                                <option value="6hours">6小时内</option>
                                <option value="1day" selected>一天内</option>
                                <option value="1week">一周内</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-save" id="dataTimeSaveBtn" title="保存设置">保存</button>
            </div>
        </div>
    </dialog>

    <!-- AI对话侧边栏 -->
    <div class="ai-sidebar" id="aiSidebar">
        <div class="ai-sidebar-header">
            <div class="ai-header-title">
                <span class="ai-header-icon">🤖</span>
                <span>AI 环境分析助手</span>
            </div>
            <div class="ai-header-actions">
                <button class="ai-settings-btn" id="aiSettingsBtn" title="API设置">
                    <svg class="ai-settings-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#00d9ff" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3.2" fill="#fff" stroke="#00d9ff" stroke-width="2"/>
                        <circle cx="12" cy="12" r="1.2" fill="#00d9ff" stroke="#00d9ff" stroke-width="1.2"/>
                        <path
                          d="M19.4 13c.04-.33.06-.66.06-1s-.02-.67-.06-1
                             l2.11-1.65a.5.5 0 00.12-.64l-2-3.46a.5.5 0 00-.6-.22
                             l-2.49 1a7.03 7.03 0 00-1.73-1l-.38-2.65A.5.5 0 0014 2
                             h-4a.5.5 0 00-.5.42l-.38 2.65a7.03 7.03 0 00-1.73 1
                             l-2.49-1a.5.5 0 00-.6.22l-2 3.46a.5.5 0 00.12.64L4.6 11
                             c-.04.33-.06.66-.06 1s.02.67.06 1l-2.11 1.65a.5.5 0 00-.12.64
                             l2 3.46a.5.5 0 00.6.22l2.49-1c.54.42 1.12.77 1.73 1l.38 2.65A.5.5 0 0010 22
                             h4a.5.5 0 00.5-.42l.38-2.65c.61-.23 1.19-.58 1.73-1l2.49 1a.5.5 0 00.6-.22
                             l2-3.46a.5.5 0 00-.12-.64L19.4 13z"
                        />
                        <line x1="12" y1="10.2" x2="12" y2="7.8" stroke="#00d9ff" stroke-width="1.2"/>
                        <line x1="12" y1="16.2" x2="12" y2="13.8" stroke="#00d9ff" stroke-width="1.2"/>
                        <line x1="13.8" y1="12" x2="16.2" y2="12" stroke="#00d9ff" stroke-width="1.2"/>
                        <line x1="7.8" y1="12" x2="10.2" y2="12" stroke="#00d9ff" stroke-width="1.2"/>
                    </svg>
                </button>
                <button class="ai-close-btn" id="aiCloseBtn" title="关闭">
                    <svg class="ai-close-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="ai-chat-container" id="aiChatContainer">
            <div class="ai-welcome-message">
                <div class="ai-avatar">🤖</div>
                <div class="ai-message-content">
                    <p>👋 你好！我是AI环境分析助手。</p>
                    <p>我已读取当前环境数据，可以为你分析提供专业建议。</p>
                    <div class="ai-quick-actions">
                        <button class="ai-quick-btn" data-action="analyze">📊 分析当前环境</button>
                        <button class="ai-quick-btn" data-action="comfort">🌡️ 舒适度评估</button>
                        <button class="ai-quick-btn" data-action="advice">💡 环境建议</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="ai-input-container">
            <div class="ai-current-data" id="aiCurrentData">
                <span class="data-tag">🌡️ <span id="aiTemp">--</span>℃</span>
                <span class="data-tag">💧 <span id="aiHumidity">--</span>%</span>
                <span class="data-tag">💨 <span id="aiWind">--</span>m/s</span>
                <span class="data-tag">☀️ <span id="aiLight">--</span>lux</span>
                <span class="data-tag">🌳 <span id="aiPM25">--</span>μg/m³</span>
                <span class="data-tag">⛱️ <span id="aiUV">--</span>UVI</span>
            </div>
            <div class="ai-input-wrapper">
                <textarea id="aiInput" placeholder="输入问题，或点击上方快捷按钮..." rows="1"></textarea>
                <button class="ai-send-btn" id="aiSendBtn">
                    <span>发送</span>
                </button>
            </div>
        </div>
    </div>

    <!-- AI助手浮动按钮 -->
    <div class="ai-assistant-btn" id="aiAssistantBtn" title="AI环境分析助手">
        <span class="ai-icon">🤖</span>
        <span class="ai-pulse"></span>
    </div>

    <!-- AI设置弹窗 -->
    <dialog class="ai-config-modal" id="aiConfigModal">
        <div class="modal-mask"></div>
        <div class="modal-loading-mask is-hidden" id="aiConfigLoadingMask">
            <div class="modal-loading-spinner"></div>
        </div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <div class="modal-header">
                <h3 class="modal-title">AI 接口配置</h3>
                <button type="button" class="modal-close" id="aiConfigClose" aria-label="关闭">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group form-group-with-button">
                    <div class="form-input-wrapper">
                        <label for="aiModel">模型选择</label>
                        <select id="aiModel" class="enhanced-select">
                            <option value="doubao-seed-1-6-flash-250828" data-icon="⚡">⚡ 豆包-1.6 Flash (推荐)</option>
                            <option value="doubao-1-5-pro-32k-250115" data-icon="🚀">🚀 豆包-1.5 Pro</option>
                            <option value="doubao-1-5-lite-32k-250115" data-icon="🌱">🌱 豆包-1.5 Lite</option>
                            <option value="doubao-seed-1-6-lite-251015" data-icon="🌟">🌟 豆包-1.6 Lite</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-api-get" id="aiModalApiBtn" title="向MQTT发送API请求">
                        <span>🔗 获取API</span>
                    </button>
                </div>
                <div class="form-group">
                    <label for="aiApiKey">API Key</label>
                    <input type="password" id="aiApiKey" placeholder="输入火山方舟 API Key">
                    <p class="form-hint">火山方舟控制台获取：<a href="https://console.volcengine.com/ark/region:ark+cn-beijing/apiKey" target="_blank">console.volcengine.com/ark</a></p>
                </div>
                <div class="form-tip">
                    <p>🔒 API Key 仅存储在本地浏览器，不会上传到服务器</p>
                    <p>🤖 使用火山方舟豆包大模型提供 AI 服务</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-test" id="aiTestBtn">测试连接</button>
                <button type="button" class="btn btn-save" id="aiSaveBtn">保存配置</button>
            </div>
        </div>
    </dialog>

    <!-- 环境设备控制弹窗 (仅管理员可见) -->
    <dialog class="chart-settings-modal device-control-modal" id="deviceControlModal">
        <div class="modal-mask"></div>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="deviceControlTitle">
            <div class="modal-header">
                <h3 class="modal-title" id="deviceControlTitle">设备控制</h3>
                <button type="button" class="modal-close" id="deviceControlClose" aria-label="关闭">×</button>
            </div>
            <div class="modal-body">
                <form id="deviceControlForm">
                    <!-- 控制模式 -->
                    <div class="settings-row">
                        <label class="settings-label">控制模式</label>
                        <div class="settings-control">
                            <div class="control-toggle-group">
                                <button type="button" class="control-toggle-btn" data-control="auto" data-value="1" title="自动模式">
                                    🤖 自动
                                </button>
                                <button type="button" class="control-toggle-btn" data-control="auto" data-value="0" title="手动模式">
                                    ✋ 手动
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 灯光控制 -->
                    <div class="settings-row">
                        <label class="settings-label">灯光控制</label>
                        <div class="settings-control">
                            <div class="control-toggle-group">
                                <button type="button" class="control-toggle-btn control-toggle-on" data-control="light" data-value="1" title="开灯">
                                    💡 开灯
                                </button>
                                <button type="button" class="control-toggle-btn control-toggle-off" data-control="light" data-value="0" title="关灯">
                                    🌙 关灯
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-save" id="deviceControlCloseBtn">关闭</button>
            </div>
        </div>
    </dialog>

    <!-- 自定义提示弹窗 -->
    <dialog class="toast-alert-modal" id="toastAlertModal">
        <div class="modal-mask"></div>
        <div class="toast-alert-content">
            <div class="toast-alert-body">
                <p id="toastAlertMessage"></p>
            </div>
            <div class="toast-alert-footer">
                <button type="button" class="btn btn-save" id="toastAlertBtn">确定</button>
            </div>
        </div>
    </dialog>

    <!-- 引入JS文件 -->
    <script src="js/toast-alert.js"></script>
    <script src="js/mqtt.js"></script>
    <script src="js/chart.js"></script>
    <script src="js/menu-utils.js"></script>
    <script src="js/main-utils.js"></script>
    <script src="js/ai-assistant.js"></script>

</body>
</html>